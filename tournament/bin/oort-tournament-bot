#!/usr/bin/env ruby
require 'oort-tournament/db'
require 'oort-tournament/forum'

SHA1_REGEX = /\b[0-9a-fA-F]{20}\b/

USERNAME = ARGV[0] or fail "username required"
PASSWORD = ARGV[1] or fail "password required"

db = OortTournament::DB.new

forum = OortForum.new
forum.login USERNAME, PASSWORD

forum.list_messages.each do |msgid|
  next if db.seen_msgids.member? msgid
  puts "processing message #{msgid}"
  begin
    msg = forum.get_message msgid

    puts "wrong site" unless msg.site == 'from: oort.lefora.com'

    puts "no gist found" unless msg.body =~ SHA1_REGEX
    gist = $&

    puts "no name found" unless msg.subject =~ /Message: (\w+)$/
    name = $1

    fail "name conflict" if db.ais.member? name

    puts "#{msg.sender.inspect} registered #{name} as #{gist}"
    db.create_ai name, msg.sender, gist
    db.seen_msgids << msgid

    msg.reply "Your AI has been registered in the tournament."
  rescue
    puts "failed to process message #{msgid}: #{$!.message}"
    msg.reply "Failed to register AI: #{$!.message}" if msg
    #puts page.send :html_body
  end
end

db.save
